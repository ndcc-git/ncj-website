{% extends "adm_base.html" %}

{% block title %}Admin Segment Registrations{% endblock %}

{% block content %}

<section class="section is-title-bar">
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <ul>
                    <li>Admin</li>
                    <li>CA Registrations</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<form method="GET" action="{{ url_for('admin.admin_ca_registrations') }}">
    <div class="field is-grouped is-align-items-center">

        <!-- Segment -->
        <div class="field is-horizontal mx-3">
            <div class="field-label is-normal">
                <label class="label">Status:</label>
            </div>
            <div class="field-body">
                <div class="field">
                    <div class="control">
                        <div class="select">
                            <select name="status">
                                <option value="all" {% if status_filter=='all' %}selected{% endif %}>All</option>
                                <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending
                                </option>
                                <option value="approved" {% if status_filter=='approved' %}selected{% endif %}>Approved
                                </option>
                                <option value="rejected" {% if status_filter=='rejected' %}selected{% endif %}>Rejected
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="field is-grouped">
            <div class="control mr-3">
                <button type="submit" class="button is-link">Filter</button>
            </div>
        </div>

    </div>
</form>

<form method="GET" action="{{ url_for('admin.admin_ca_registrations') }}" class="ml-3 mb-3">
    <div class="field has-addons is-align-items-center">
        <div class="control">
            <span class="button is-static">
                <span class="icon is-small">
                    <i class="mdi mdi-magnify"></i>
                </span>
            </span>
        </div>
        
        <div class="control">
            <input class="input" type="text" placeholder="Search" name="search">
        </div>
        
        <div class="control">
            <button type="submit" class="button is-link">Search</button>
        </div>
    </div>
</form>



<div class="card has-table">
    <header class="card-header">
        <p class="card-header-title">
            <span class="icon"><i class="mdi mdi-account-multiple"></i></span>
            CA Registrations
        </p>
        <a href="{{ request.url }}" class="card-header-icon">
            <span class="icon"><i class="mdi mdi-reload"></i></span>
        </a>
    </header>
    <div class="card-content">
        <div class="b-table has-pagination">
            <div class="table-wrapper has-mobile-cards">
                <table class="table is-fullwidth is-striped is-hoverable is-fullwidth">
                    <thead>
                        <tr>
                            <th>CA Code</th>
                            <th>Name</th>
                            <th>Institution</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Class</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ca in ca_registrations %}
                        <tr data-id="{{ ca._id }}">
                            <td data-label="CA Code">
                                <strong>{{ ca.ca_code }}</strong>
                            </td>
                            <td data-label="Name">{{ ca.full_name }}</td>
                            <td data-label="Institution">{{ ca.institution }}</td>
                            <td data-label="Email">{{ ca.email }}</td>
                            <td data-label="Phone">{{ ca.phone }}</td>
                            <td data-label="Class">{{ ca.class }}</td>
                            <td data-label="Date">
                                <small class="has-text-grey is-abbr-like" title="Oct 25, 2020">
                                    {{ ca.registration_date.strftime('%#d %b %Y') }}
                                </small>
                            </td>
                            <td data-label="Status">
                                <span class="tag 
                                {% if ca.status == 'approved' %}is-success
                                {% elif ca.status == 'rejected' %}is-danger
                                {% elif ca.status == 'pending' %}is-warning
                                {% else %}is-light
                                {% endif %}">
                                    {{ ca.status|title }}
                                </span>

                            </td>

                            <td class="is-actions-cell">
                                <div class="buttons">
                                    <button class="button is-small is-info view-btn" data-id="{{ ca._id }}"
                                        id="open-modal" type="button">
                                        View
                                    </button>
                                    {% if ca.status == 'pending' %}
                                    <button class="button is-small is-primary" type="button">
                                        Approve
                                    </button>
                                    {% endif %}
                                    <!-- <button class="button is-small is-primary" type="button">
                                        Reject
                                    </button> -->
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="notification">
                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <div class="buttons has-addons">
                                <button type="button" class="button is-active">1</button>
                                <button type="button" class="button">2</button>
                                <button type="button" class="button">3</button>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <small>Page 1 of 3</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="caDetailsModal">
    <div class="modal-background"></div>

    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">CA Application Details</p>
            <button class="delete" aria-label="close"></button>
        </header>

        <section class="modal-card-body" id="caDetailsContent">
            <!-- JS injects content here -->
        </section>

        <footer class="modal-card-foot">
            <button class="button is-dark is-light" id="closeCADetails">Close</button>
        </footer>
    </div>
</div>



{% endblock %}

{% block scripts %}

<script>
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const caId = this.dataset.id;
            fetch(`/api/ca-details/${caId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCADetails(data.ca);
                    }
                });
        });
    });

    function showCADetails(ca) {
        const modal = document.getElementById('caDetailsModal');
        const content = document.getElementById('caDetailsContent');

        content.innerHTML = `
    <div class="card">
      <div class="card-content">

        <div class="media">
          ${ca.profile_picture ? `
          <div class="media-left">
            <figure class="image is-128x128">
              <img class="is-rounded" 
                   src="/static/uploads/ca_profiles/${ca.profile_picture}">
            </figure>
          </div>` : ""}

          <div class="media-content">
            <p class="title is-4">${ca.full_name}</p>
            <p class="subtitle is-6">${ca.email}</p>

            <span class="tag is-info is-light mr-2">${ca.ca_code}</span>
            <span class="tag ${ca.status === "approved" ? "is-success" : ca.status === "rejected" ? "is-danger" : "is-warning"}">
              ${ca.status.toUpperCase()}
            </span>
          </div>
        </div>

        <hr>

        <div class="content">
          <p><strong>Institution:</strong> ${ca.institution}</p>
          <p><strong>Class/Year:</strong> ${ca.class}</p>
          <p><strong>Phone:</strong> ${ca.phone}</p>
          <p><strong>IP Address:</strong> ${ca.ip_address}</p>
          <p><strong>Registration Date:</strong> ${new Date(ca.registration_date).toLocaleString()}</p>

          <div class="box mt-4">
            <p class="has-text-weight-semibold mb-2">Why CA?</p>
            <p>${ca.why_ca}</p>
          </div>
        </div>

      </div>
    </div>
  `;

        modal.classList.add("is-active");
    }



    document.querySelectorAll("#caDetailsModal .delete, #closeCADetails, #caDetailsModal .modal-background")
        .forEach(el => {
            el.addEventListener("click", () => {
                document.getElementById("caDetailsModal").classList.remove("is-active");
            });
        });

</script>


{% endblock %}