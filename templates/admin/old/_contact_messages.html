{% extends "base.html" %}

{% block title %}Contact Messages{% endblock %}

{% block content %}
<div class="admin-contact-messages">
    <h2>Contact Messages</h2>
    
    <div class="message-stats">
        <div class="stat-card">
            <h3>Total Messages</h3>
            <p class="stat-number">{{ total_messages }}</p>
        </div>
        <div class="stat-card">
            <h3>Unread Messages</h3>
            <p class="stat-number">{{ unread_count }}</p>
        </div>
    </div>
    
    <div class="filters">
        <form method="GET" action="{{ url_for('admin_contact_messages') }}">
            <div class="filter-group">
                <label for="status">Status:</label>
                <select name="status" id="status">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                    <option value="unread" {% if status_filter == 'unread' %}selected{% endif %}>Unread</option>
                    <option value="read" {% if status_filter == 'read' %}selected{% endif %}>Read</option>
                    <option value="replied" {% if status_filter == 'replied' %}selected{% endif %}>Replied</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">Filter</button>
            <button type="button" id="mark-all-read" class="btn btn-secondary">Mark All as Read</button>
        </form>
    </div>
    
    {% if contact_messages %}
    <table id="messages-table">
        <thead>
            <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Institution</th>
                <th>Email</th>
                <th>Message Preview</th>
                <th>Submitted</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for message in contact_messages %}
            <tr class="message-row {% if message.status == 'unread' %}unread{% endif %}" data-id="{{ message._id }}">
                <td>
                    <span class="status-badge status-{{ message.status }}">
                        {{ message.status|title }}
                    </span>
                    {% if message.archived %}
                    <span class="badge badge-archived">Archived</span>
                    {% endif %}
                </td>
                <td>{{ message.name }}</td>
                <td>{{ message.institution }}</td>
                <td><a href="mailto:{{ message.email }}">{{ message.email }}</a></td>
                <td class="message-preview">
                    {{ message.message[:100] }}{% if message.message|length > 100 %}...{% endif %}
                </td>
                <td>{{ message.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <div class="message-actions">
                        <button class="btn btn-sm btn-info view-message" data-id="{{ message._id }}">View</button>
                        {% if message.status == 'unread' %}
                        <button class="btn btn-sm btn-success mark-read" data-id="{{ message._id }}">Mark Read</button>
                        {% endif %}
                        {% if not message.archived %}
                        <button class="btn btn-sm btn-warning archive-message" data-id="{{ message._id }}">Archive</button>
                        {% else %}
                        <button class="btn btn-sm btn-secondary unarchive-message" data-id="{{ message._id }}">Unarchive</button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger delete-message" data-id="{{ message._id }}">Delete</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-messages">
        <p>No contact messages found.</p>
    </div>
    {% endif %}
</div>

<!-- Modal for viewing message details -->
<div id="messageDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="messageDetailsContent">
            <!-- Message details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mark message as read
    document.querySelectorAll('.mark-read').forEach(btn => {
        btn.addEventListener('click', function() {
            updateMessageStatus(this.dataset.id, 'read');
        });
    });
    
    // Archive message
    document.querySelectorAll('.archive-message').forEach(btn => {
        btn.addEventListener('click', function() {
            archiveMessage(this.dataset.id, true);
        });
    });
    
    // Unarchive message
    document.querySelectorAll('.unarchive-message').forEach(btn => {
        btn.addEventListener('click', function() {
            archiveMessage(this.dataset.id, false);
        });
    });
    
    // Delete message
    document.querySelectorAll('.delete-message').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
                deleteMessage(this.dataset.id);
            }
        });
    });
    
    // Mark all as read
    document.getElementById('mark-all-read').addEventListener('click', function() {
        if (confirm('Mark all messages as read?')) {
            const messageIds = Array.from(document.querySelectorAll('.message-row')).map(row => row.dataset.id);
            updateMessageStatus(messageIds, 'read');
        }
    });
    
    function updateMessageStatus(messageId, status) {
        const ids = Array.isArray(messageId) ? messageId : [messageId];
        const meta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = meta.getAttribute("content");
        fetch('/admin/update-message-status/' + (Array.isArray(messageId) ? 'bulk' : messageId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                status: status,
                message_ids: Array.isArray(messageId) ? messageId : undefined
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update status: ' + data.message);
            }
        });
    }
    
    function archiveMessage(messageId, archive) {
        const meta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = meta.getAttribute("content");
        fetch(`/admin/update-message-status/${messageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ archived: archive })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to archive message: ' + data.message);
            }
        });
    }
    
    function deleteMessage(messageId) {
        const meta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = meta.getAttribute("content");
        fetch(`/admin/delete-message/${messageId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete message: ' + data.message);
            }
        });
    }
    
    // View message details
    document.querySelectorAll('.view-message').forEach(btn => {
        btn.addEventListener('click', function() {
            const messageId = this.dataset.id;
            
            // Mark as read when viewing
            if (this.closest('.message-row').classList.contains('unread')) {
                updateMessageStatus(messageId, 'read');
            }
            
            fetch(`/api/message-details/${messageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessageDetails(data.message);
                    }
                });
        });
    });
    
    function showMessageDetails(message) {
        const modal = document.getElementById('messageDetailsModal');
        const content = document.getElementById('messageDetailsContent');
        
        content.innerHTML = `
            <h3>Message Details</h3>
            <div class="message-details">
                <div class="detail-row">
                    <strong>From:</strong> ${message.name}
                </div>
                <div class="detail-row">
                    <strong>Institution:</strong> ${message.institution}
                </div>
                <div class="detail-row">
                    <strong>Email:</strong> <a href="mailto:${message.email}">${message.email}</a>
                </div>
                <div class="detail-row">
                    <strong>Submitted:</strong> ${new Date(message.submitted_at).toLocaleString()}
                </div>
                <div class="detail-row">
                    <strong>Status:</strong> <span class="status-badge status-${message.status}">${message.status}</span>
                </div>
                <div class="detail-row">
                    <strong>IP Address:</strong> ${message.ip_address}
                </div>
                <div class="detail-row">
                    <strong>Message:</strong>
                    <div class="message-content">
                        ${message.message.replace(/\n/g, '<br>')}
                    </div>
                </div>
            </div>
            <div class="message-actions-modal">
                <button onclick="updateMessageStatus('${message._id}', 'read')" class="btn btn-sm btn-success">Mark as Read</button>
                <button onclick="updateMessageStatus('${message._id}', 'replied')" class="btn btn-sm btn-info">Mark as Replied</button>
                ${message.archived ? 
                    `<button onclick="archiveMessage('${message._id}', false)" class="btn btn-sm btn-secondary">Unarchive</button>` :
                    `<button onclick="archiveMessage('${message._id}', true)" class="btn btn-sm btn-warning">Archive</button>`
                }
                <button onclick="deleteMessage('${message._id}')" class="btn btn-sm btn-danger">Delete</button>
            </div>
        `;
        
        modal.style.display = 'block';
    }
    
    // Modal close functionality
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('messageDetailsModal').style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('messageDetailsModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}