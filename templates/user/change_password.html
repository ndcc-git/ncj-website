{% extends "base.html" %}

{% block title %}Change Password - Festival Registration{% endblock %}

{% block content %}
<div class="change-password-container">
    <div class="password-card">
        <div class="password-header">
            <h2><i class="password-icon">üîí</i> Change Password</h2>
            <p>Update your account password</p>
        </div>
        
        <form method="POST" action="{{ url_for('change_password') }}">
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                {{ form.current_password.label }}
                {{ form.current_password(class="form-control", placeholder="Enter your current password") }}
                {% if form.current_password.errors %}
                    <div class="errors">
                        {% for error in form.current_password.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-text">
                    <a href="{{ url_for('forgot_password') }}" class="forgot-link">Forgot your current password?</a>
                </small>
            </div>
            
            <div class="form-group">
                {{ form.new_password.label }}
                {{ form.new_password(class="form-control", placeholder="Enter new password (min. 8 characters)") }}
                {% if form.new_password.errors %}
                    <div class="errors">
                        {% for error in form.new_password.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-text">
                    Password must contain:
                    <ul class="password-requirements">
                        <li id="length-req">At least 8 characters</li>
                        <li id="upper-req">One uppercase letter (A-Z)</li>
                        <li id="lower-req">One lowercase letter (a-z)</li>
                        <li id="number-req">One number (0-9)</li>
                    </ul>
                </small>
            </div>
            
            <div class="form-group">
                {{ form.confirm_new_password.label }}
                {{ form.confirm_new_password(class="form-control", placeholder="Confirm your new password") }}
                {% if form.confirm_new_password.errors %}
                    <div class="errors">
                        {% for error in form.confirm_new_password.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                <div id="password-match" class="form-text"></div>
            </div>
            
            <div class="form-group">
                {{ form.submit(class="btn btn-primary btn-lg btn-block") }}
                <a href="{{ url_for('user_profile') }}" class="btn btn-secondary btn-block mt-2">Cancel</a>
            </div>
        </form>
    </div>
    
    <div class="security-tips">
        <div class="tips-card">
            <h3><i class="tips-icon">üí°</i> Password Security Tips</h3>
            <ul>
                <li><strong>Use a unique password</strong> that you don't use elsewhere</li>
                <li><strong>Avoid personal information</strong> like your name, birthdate, or phone number</li>
                <li><strong>Consider using a passphrase</strong> like "BlueSky@Festival2024!"</li>
                <li><strong>Change your password regularly</strong> every 3-6 months</li>
                <li><strong>Never share your password</strong> with anyone</li>
                <li><strong>Use a password manager</strong> to securely store your passwords</li>
            </ul>
            
            <div class="additional-security">
                <h4><i class="security-icon">üõ°Ô∏è</i> Additional Security</h4>
                <div class="security-actions">
                    <a href="{{ url_for('verify_email') }}" class="btn btn-sm btn-outline-info">
                        <i class="icon">üìß</i> Verify Email
                    </a>
                    <a href="{{ url_for('user_profile') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="icon">üë§</i> Back to Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_new_password');
        const matchDiv = document.getElementById('password-match');
        const requirements = {
            length: document.getElementById('length-req'),
            upper: document.getElementById('upper-req'),
            lower: document.getElementById('lower-req'),
            number: document.getElementById('number-req')
        };
        
        // Password validation function
        function validatePassword(password) {
            const hasLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            
            // Update requirement indicators
            requirements.length.classList.toggle('valid', hasLength);
            requirements.upper.classList.toggle('valid', hasUpper);
            requirements.lower.classList.toggle('valid', hasLower);
            requirements.number.classList.toggle('valid', hasNumber);
            
            return hasLength && hasUpper && hasLower && hasNumber;
        }
        
        // Password match function
        function checkPasswordMatch() {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (!password || !confirmPassword) {
                matchDiv.textContent = '';
                matchDiv.className = 'form-text';
                return;
            }
            
            if (password === confirmPassword) {
                matchDiv.textContent = '‚úì Passwords match';
                matchDiv.className = 'form-text match';
            } else {
                matchDiv.textContent = '‚úó Passwords do not match';
                matchDiv.className = 'form-text mismatch';
            }
        }
        
        // Real-time validation
        newPasswordInput.addEventListener('input', function() {
            validatePassword(this.value);
            checkPasswordMatch();
        });
        
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        
        // Form submission validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (!validatePassword(password)) {
                e.preventDefault();
                alert('Please ensure your password meets all requirements.');
                return;
            }
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match. Please check and try again.');
                return;
            }
        });
        
        // Initialize validation
        if (newPasswordInput.value) {
            validatePassword(newPasswordInput.value);
            checkPasswordMatch();
        }
    });
</script>
{% endblock %}