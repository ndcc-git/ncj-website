{% extends "adm_base.html" %}

{% block title %}Admin Accounts{% endblock %}

{% block content %}

<section class="section is-title-bar">
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <ul>
                    <li>Admin</li>
                    <li>Accounts</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<section class="section">
  <div class="container">

    <h1 class="title is-3">Admin User Management</h1>
    <p class="subtitle is-6 has-text-grey">Manage admin accounts and permissions</p>

    <div class="columns is-variable is-5">

      <!-- Add Admin -->
      <div class="column is-4">
        <div class="card">
          <header class="card-header">
            <p class="card-header-title">âž• Add New Admin</p>
          </header>

          <div class="card-content">

            <div class="notification is-info is-light">
              All admin users have equal privileges.
            </div>

            <form method="POST" action="{{ url_for('admin.admin_users') }}">
              {{ form.hidden_tag() }}

              <div class="field">
                {{ form.name.label(class="label") }}
                <div class="control">
                  {{ form.name(class="input", placeholder="Full name") }}
                </div>
                {% for e in form.name.errors %}
                <p class="help is-danger">{{ e }}</p>
                {% endfor %}
              </div>

              <div class="field">
                {{ form.email.label(class="label") }}
                <div class="control">
                  {{ form.email(class="input", placeholder="Email address") }}
                </div>
                {% for e in form.email.errors %}
                <p class="help is-danger">{{ e }}</p>
                {% endfor %}
              </div>

              <div class="field">
                {{ form.password.label(class="label") }}
                <div class="control">
                  {{ form.password(class="input", placeholder="Password (min 6 chars)") }}
                </div>
                {% for e in form.password.errors %}
                <p class="help is-danger">{{ e }}</p>
                {% endfor %}
              </div>

              <div class="field">
                {{ form.confirm_password.label(class="label") }}
                <div class="control">
                  {{ form.confirm_password(class="input", placeholder="Confirm password") }}
                </div>
                {% for e in form.confirm_password.errors %}
                <p class="help is-danger">{{ e }}</p>
                {% endfor %}
              </div>

              <div class="field mt-4">
                <button class="button is-link is-fullwidth">
                  Create Admin
                </button>
              </div>
            </form>

            <p class="has-text-grey mt-4 is-size-7">
              ðŸ”’ Passwords are securely hashed.
            </p>
          </div>
        </div>
      </div>

      <!-- Admin List -->
      <div class="column is-8">
        <div class="card">
          <header class="card-header">
            <p class="card-header-title">
              ðŸ‘¥ Admin Users ({{ admin_users|length }})
            </p>
            <div class="card-header-icon has-text-grey is-size-7 pr-4">
              Logged in as: <strong class="ml-1">{{ session.admin_email }}</strong>
            </div>
          </header>

          <div class="card-content">
            {% if admin_users %}
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable is-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>By</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in admin_users %}
                  <tr {% if user.email == session.admin_email %}class="has-background-link-light"{% endif %}>
                    <td>
                      {{ user.name }}
                      {% if user.email == session.admin_email %}
                        <span class="tag is-link is-light ml-2">You</span>
                      {% endif %}
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                    <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                    <td>{{ user.created_by or 'System' }}</td>
                    <td>
                      {% if user.email != session.admin_email %}
                        <div class="buttons are-small">
                          <button class="button is-info reset-password-btn"
                                  data-id="{{ user._id }}"
                                  data-email="{{ user.email }}">
                            Reset
                          </button>
                          <button class="button is-danger delete-user-btn"
                                  data-id="{{ user._id }}"
                                  data-email="{{ user.email }}">
                            Delete
                          </button>
                        </div>
                      {% else %}
                        <span class="has-text-grey">Current</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <p class="has-text-grey has-text-centered">No admin users found.</p>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- Reset Password Modal -->
<div class="modal" id="resetPasswordModal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Reset Password</p>
      <button class="delete close-modal"></button>
    </header>

    <section class="modal-card-body">

      <div class="field">
        <label class="label">New Password</label>
        <input class="input" type="password" id="new_password" placeholder="Min 6 characters">
      </div>

      <div class="field">
        <label class="label">Confirm Password</label>
        <input class="input" type="password" id="confirm_new_password">
      </div>

      <div id="resetPasswordMessage" class="notification is-hidden"></div>

    </section>

    <footer class="modal-card-foot is-justify-content-flex-end">
      <button class="button close-modal">Cancel</button>
      <button class="button is-link" id="confirmResetBtn">Reset</button>
    </footer>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
let currentUserId = null;

/* ------------------------------
   Bulma modal helpers
------------------------------ */
function openModal() {
  document.getElementById('resetPasswordModal').classList.add('is-active');
}

function closeModal() {
  document.getElementById('resetPasswordModal').classList.remove('is-active');
}

/* ------------------------------
   Open reset password modal
------------------------------ */
document.querySelectorAll('.reset-password-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    currentUserId = this.dataset.id;
    const email = this.dataset.email;

    document.querySelector('#resetPasswordModal .modal-card-title').textContent =
      `Reset Password for ${email}`;

    document.getElementById('new_password').value = '';
    document.getElementById('confirm_new_password').value = '';

    const msg = document.getElementById('resetPasswordMessage');
    msg.className = 'notification is-hidden';
    msg.textContent = '';

    openModal();
  });
});

/* ------------------------------
   Close modal buttons
------------------------------ */
document.querySelectorAll('.close-modal, .modal-background').forEach(el => {
  el.addEventListener('click', closeModal);
});

/* ------------------------------
   Confirm reset password
------------------------------ */
document.getElementById('confirmResetBtn').addEventListener('click', function () {
  const newPassword = document.getElementById('new_password').value;
  const confirmPassword = document.getElementById('confirm_new_password').value;
  const messageDiv = document.getElementById('resetPasswordMessage');

  if (newPassword.length < 6) {
    return showMessage('Password must be at least 6 characters', false, messageDiv);
  }

  if (newPassword !== confirmPassword) {
    return showMessage('Passwords do not match', false, messageDiv);
  }

  const meta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = meta ? meta.getAttribute("content") : "";

  fetch(`/admin/users/${currentUserId}/reset-password`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ new_password: newPassword })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showMessage('Password reset successfully', true, messageDiv);
      setTimeout(() => {
        closeModal();
        location.reload();
      }, 1200);
    } else {
      showMessage(data.message || 'Reset failed', false, messageDiv);
    }
  })
  .catch(err => {
    showMessage('Network error: ' + err, false, messageDiv);
  });
});

/* ------------------------------
   Delete admin user
------------------------------ */
document.querySelectorAll('.delete-user-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    const userId = this.dataset.id;
    const email = this.dataset.email;

    if (!confirm(`Delete admin user "${email}"? This cannot be undone.`)) return;

    const meta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = meta ? meta.getAttribute("content") : "";

    fetch(`/admin/users/${userId}/delete`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || 'Delete failed');
      }
    })
    .catch(err => alert('Network error: ' + err));
  });
});

/* ------------------------------
   Bulma-style message helper
------------------------------ */
function showMessage(message, success, element) {
  element.textContent = message;
  element.className = `notification ${success ? 'is-success' : 'is-danger'}`;
  element.classList.remove('is-hidden');
}
</script>


{% endblock %}